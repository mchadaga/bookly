{% extends "web/base.html" %} {% load i18n %} {% load static %} {% block body %}
{% comment %} {{hooks}} {% endcomment %}

<div class="flex flex-col items-center justify-center w-full min-h-screen">
  <div id="text-content" class="text-content" style="display: none; width: 75%">
    <h1 id="hook-text"></h1>
      <div id="paragraphs"></div>
      <div class="spacer"></div>
    </div>
  </div>

  <input
  placeholder = "Press [Space] to read further, [Enter] for next story, or input in any questions you have for HookBook AI here."
  id="entered"
  style="
    font-size: 16px;
    padding-left: 15px;
    position: fixed;
    bottom: 1vw;
    left: 12.5vw;
    width: 75vw;
    border-radius:2.5rem; 
    height: 50px;
    display: none;

    "
  />

  <div
  id = "entered-placeholder"
  style="
  font-size: 16px;
  padding-left: 15px;
  position: fixed;
  bottom: 1vw;
    left: 50%;
    transform: translateX(-50%);
  border-radius:2.5rem; 
  height: 50px;
  display:block; 
  font-size: 1.5rem;

  "
    >

    Press [Space] to read more

  </div>


  <div
  
  id = "endstorymsg"
  style="
  font-size: 16px;
  padding-left: 15px;
  position: fixed;
  bottom: 1vw;
    left: 50%;
    transform: translateX(-50%);
  border-radius:2.5rem; 
  display:none; 
  font-size: 1.5rem;
  background:rgb(255,255,255);
  border-radius: 1rem;
  padding: 1rem;
  color: rgb(0,0,0);
  white-space: nowrap; 
  
  "


    >
  Congrats! You've finised this story ðŸŽ‰! Press [Enter] to read your next story
  </div>


  <div>
    {% comment %}
    <div
      id="clicked-textcontents"
      style="font-size: 0.8em; margin-top: 20px"
    ></div>
    {% endcomment %}



    <style>
      .text-content h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
      }
      .sentence {
        font-size: 1.5rem;
        line-height: 1.6;
        margin-bottom: 1rem;
      }
      .spacer {
        height: 40vh;
      }
      #chat-container {
        position: fixed;
        top: 60px;
        right: 20px;
        width: 300px;
        height: calc(100vh - 120px);
        overflow-y: auto;
        background-color: rgba(255, 255, 255, 0.9);
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
      }
      .chat-message {
        margin: 1rem 0;
        padding: 0.5rem;
        border-radius: 5px;
        color: #000;
      }
      .user-message {
        background-color: #e6f2ff;
      }
      .ai-message {
        background-color: #f0f0f0;
      }
    </style>

    <script>
      let currentSentenceIndex = -1;
      let currentTextContentId = null;
      let enteredStory = false;
      let storyFinished = false;
      let chatInputFocused = false;
      let chatHistory = [];




      let enteredPlaceholder = document.getElementById("entered-placeholder");
      let entered = document.getElementById("entered");
      let endStoryMsg = document.getElementById("endstorymsg"); 
      let spacer = document.querySelector(".spacer");


      function fetchRandomTextContent() {
        const url = new URL(
          '{% url "app:get_random_textcontent" %}',
          window.location.origin
        );
        console.log(enteredStory);
        url.searchParams.append("entered", enteredStory);

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            currentTextContentId = data.id;
            document.getElementById("hook-text").textContent = data.hook;
            const paragraphsContainer = document.getElementById("paragraphs");
            paragraphsContainer.innerHTML = "";
            data.paragraphs.forEach((paragraph) => {
              paragraph.sentences.forEach((sentence) => {
                const p = document.createElement("p");
                p.className = "sentence";
                p.style.display = "none";
                p.textContent = sentence.sentence_text;
                paragraphsContainer.appendChild(p);
              });
            });
            currentSentenceIndex = -1;
            document.getElementById("text-content").style.display = "block";

            speakHook(data.hook);

            // Reset enteredStory for the next fetch
            enteredStory = false;
          })
          .catch((error) => console.error("Error:", error));
      }

      function speakHook(text) {
        setTimeout(() => {
          const utterance = new SpeechSynthesisUtterance(text);
          window.speechSynthesis.speak(utterance);
        }, 100);
      }

      function trackTextContentClick() {
        if (currentTextContentId) {
          fetch('{% url "app:track_textcontent_click" %}', {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: `textcontent_id=${currentTextContentId}`,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success") {
                updateClickedTextContents();
              }
            })
            .catch((error) => console.error("Error:", error));
        }
      }

      function updateClickedTextContents() {
        fetch('{% url "app:get_user_textcontents" %}')
          .then((response) => response.json())
          .then((data) => {
            const container = document.getElementById("clicked-textcontents");
            container.innerHTML =
              "Clicked TextContents: " + data.map((tc) => tc.name).join(", ");
          })
          .catch((error) => console.error("Error:", error));
      }

      function askAI(userMessage) {
        const formData = new FormData();
        formData.append("textcontent_id", currentTextContentId);
        formData.append("current_sentence_index", currentSentenceIndex);
        formData.append("user_question", userMessage);
        console.log("hi");

        return fetch('{% url "app:ask_ai_about_story" %}', {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => data.ai_response)
          .catch((error) => {
            console.error("Error:", error);
            return "Sorry, I couldn't process your question. Please try again.";
          });
      }

      document.addEventListener("keydown", function (event) {
        const chatInput = document.getElementById("entered");

        if (event.key === "`") {
          event.preventDefault();
          chatInput.focus();
        }

        if (document.activeElement !== chatInput) {
          if (event.key === "Enter") {
            endStoryMsg.style.display = 'none';
            enteredPlaceholder.style.display = 'block';
            entered.style.display = 'none';

            if (storyFinished) {
              // User finished the story and wants to move to the next one
              storyFinished = false;
              enteredStory = true;
              fetchRandomTextContent();
            } else {
              // User is skipping the current story
              window.speechSynthesis.cancel();
              enteredStory = false;
              fetchRandomTextContent();
            }
          } else if (event.code === "Space") {
            enteredPlaceholder.style.display = 'none';
            entered.placeholder = "Press [Space] to read further, [Enter] for next story, or input in any questions you have for HookBook AI here."
            entered.style.display = 'block';


            event.preventDefault();
            const sentences = document.querySelectorAll(".sentence");
            if (currentSentenceIndex < sentences.length - 1) {


              currentSentenceIndex++;
              sentences[currentSentenceIndex].style.display = "block";
            




              let offset = 250; // The offset in pixels
              let elementPosition = spacer.getBoundingClientRect().top;
              let offsetPosition = elementPosition - offset;

              console.log(elementPosition)
              window.scrollBy({
                top: 60,
                behavior: "smooth" // Use "smooth" or "auto"
              });
            
              


              if (currentSentenceIndex === 0) {
                // User entered the story
             

                enteredStory = true;
                trackTextContentClick();
              }
            } else if (currentSentenceIndex === sentences.length - 1) {
                entered.placeholder = "Congrats on finishing this story! ðŸŽ‰ Press [Enter] to read your next story"
              // User has reached the last sentence
              storyFinished = true;
              // Optionally, you can display a message here to prompt the user to press Enter
              console.log(
                "Story finished. Press Enter to continue to the next story."
              );
            }
          }
        } else if (
          document.activeElement === chatInput &&
          event.key === "Enter" &&
          chatInput.value.trim() !== ""
        ) {



          event.preventDefault();
          const userMessage = chatInput.value.trim();
          chatInput.value = "";

          // Use the askAI function to get the AI response
          askAI(userMessage).then((aiResponse) => {
            updateChatDisplay(userMessage, aiResponse);

            // Auto-unfocus the input after sending a message
            chatInput.blur();
          });
        }
      });

      function updateChatDisplay(userMessage, aiResponse) {
        const paragraphsContainer = document.getElementById("paragraphs");
        const visibleSentences = Array.from(
          paragraphsContainer.children
        ).filter((el) => el.style.display !== "none");
        const lastVisibleSentence =
          visibleSentences[visibleSentences.length - 1];

        if (lastVisibleSentence) {
          const chatContainer = document.createElement("div");
          chatContainer.className = "chat-container";

          const userMessageElement = document.createElement("div");
          userMessageElement.className = "chat-message user-message";
          userMessageElement.textContent = userMessage;
          chatContainer.appendChild(userMessageElement);

          const aiMessageElement = document.createElement("div");
          aiMessageElement.className = "chat-message ai-message";
          aiMessageElement.textContent = aiResponse;
          chatContainer.appendChild(aiMessageElement);

          lastVisibleSentence.insertAdjacentElement("afterend", chatContainer);
        }
      }

      document.getElementById("entered").addEventListener("blur", function () {
        chatInputFocused = false;
      });

      fetchRandomTextContent();
      updateClickedTextContents();
    </script>

  </div>
</div>
{% endblock %}

